#!/bin/bash

max_zookeepers=$1
current_zookeepers=`grep server $ZOOKEEPER_CONF/zoo.cfg | wc -l`

while true; do
	if [[ $current_zookeepers < $max_zookeepers ]]; then
		if [[ !`grep $HOSTNAME $ZOOKEEPER_CONF/zoo.cfg` ]]; then
			((current_zookeepers += 1))
			if [[ `grep server.$current_zookeepers $ZOOKEEPER_CONF/zoo.cfg` ]]; then
				sed -i "/server.$current_zookeepers/ s/.*/server.$zookeepers=$HOSTNAME:2888:3888" $ZOOKEEPER_CONF/zoo.cfg
			else
				echo "server.$zookeepers=$HOSTNAME:2888:3888" >> $ZOOKEEPER_CONF/zoo.cfg
				echo $current_zookeepers > $ZOOKEEPER_DATA_DIR/myid
			fi
		fi 
		
	elif [[ $current_zookeepers > $max_zookeepers ]]; then
		for server in `grep server $ZOOKEEPER_CONF/zoo.cfg | sort -r`; do 
			if [[ $current_zookeepers > $max_zookeepers ]]; then
				sed -i "/$server/ s/.*//" $ZOOKEEPER_CONF/zoo.cfg
				(($current_zookeepers -= 1))
			else
				break	
			fi
		done
	current_zookeepers=`grep server $ZOOKEEPER_CONF/zoo.cfg | wc -l`
done





current_zookeepers=`grep server $ZOOKEEPER_CONF/zoo.cfg | wc -l`


java -cp $ZOOKEEPER_HOME/zookeeper.jar:$ZOOKEEPER_HOME/lib/slf4j-api-1.7.5.jar:$ZOOKEEPER_HOME/lib/slf4j-log4j12-1.7.5.jar:$ZOOKEEPER_HOME/lib/log4j-1.2.16.jar:$ZOOKEEPER_CONF/conf org.apache.zookeeper.server.quorum.QuorumPeerMain $ZOOKEEPER_CONF/zoo.cfg
